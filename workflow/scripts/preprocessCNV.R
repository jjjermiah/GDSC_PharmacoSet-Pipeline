
# WES_genes
# WES_category
# WES_total_cnv
# WGS_genes
# WGS_category
# WGS_total_cnv

## ------------------- Parse Snakemake Object ------------------- ##
if(exists("snakemake")){
    INPUT <- snakemake@input
    OUTPUT <- snakemake@output
    WILDCARDS <- snakemake@wildcards
    THREADS <- snakemake@threads
    save.image()
}

inputFilesNames <- names(INPUT)[names(INPUT) != ""]

GDSC_sampleMetadataAnnotation <- "/home/bioinf/bhklab/jermiah/psets/pset-pipelines/GDSC/metadata/Cell_Lines_Details.xlsx"
GDSC_sampleMetadataAnnotation <- data.table::as.data.table(readxl::read_xlsx(path=GDSC_sampleMetadataAnnotation, sheet=1), check.names = TRUE) 

cell_model_annotations <- data.table::fread("/home/bioinf/bhklab/jermiah/psets/pset-pipelines/GDSC/metadata/model_list_20230923.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE, nThread = THREADS)
cell_model_annotations <- cell_model_annotations[, .(model_id, sample_id, patient_id, parent_id, model_name, tissue, cancer_type)]


sampleMetadata <- merge(GDSC_sampleMetadataAnnotation, cell_model_annotations, by.x = "Sample Name", by.y = "model_name", all.x = TRUE)

## ------------------- Load Data ------------------- ##
# Load data
inputData <- lapply(inputFilesNames, function(file){
    message("Loading ", file, "...")
    if (grepl("category", file)) {
        df <- data.table::fread(INPUT[[file]], header = FALSE, sep = ",", stringsAsFactors = FALSE, nThread = THREADS)
        df <- data.table::transpose(df, make.names="V1")
    } else if (grepl("total_cnv", file)){ 
        df <- data.table::fread(INPUT[[file]], header = FALSE, sep = ",", stringsAsFactors = FALSE, nThread = THREADS)
        df <- data.table::transpose(df, make.names="V1")
    } else {
        df <- data.table::fread(INPUT[[file]], header = TRUE, sep = ",", stringsAsFactors = FALSE, nThread = THREADS)
        df
    }
    df[model_id %in% sampleMetadata[, model_id]]
})
names(inputData) <- inputFilesNames

# make output directory if it doesnt exist
dir.create(dirname(OUTPUT$preprocessedCNV), recursive = TRUE, showWarnings = FALSE)

qs::qsave(inputData, file = OUTPUT$preprocessedCNV, nthreads = THREADS)

# > str(inputData, list.len=10)
# List of 6
#  $ WES_genes    :Classes ‘data.table’ and 'data.frame': 24488104 obs. of  24 variables:
#   ..$ model_name               : chr [1:24488104] "MEC-1" "MEC-1" "MEC-1" "MEC-1" ...
#   ..$ model_id                 : chr [1:24488104] "SIDM00001" "SIDM00001" "SIDM00001" "SIDM00001" ...
#   ..$ symbol                   : chr [1:24488104] "DYNLRB2" "DONSON" "DNAJC16" "DGKD" ...
#   ..$ cancer_driver            : logi [1:24488104] FALSE FALSE FALSE FALSE FALSE FALSE ...
#   ..$ gene_id                  : chr [1:24488104] "SIDG07193" "SIDG06885" "SIDG06761" "SIDG06497" ...
#   ..$ chr_name                 : chr [1:24488104] "chr16" "chr21" "chr1" "chr2" ...
#   ..$ chr_start                : int [1:24488104] 80540800 33575355 15528860 233387980 31465229 63786773 55779687 70312332 99713137 151429771 ...
#   ..$ chr_end                  : int [1:24488104] 80550835 33588918 15568454 233469737 31473290 63818618 55816817 70366437 99756016 151438521 ...
#   ..$ total_copy_number        : num [1:24488104] 2 2 2 2 2 ...
#   ..$ minor_copy_number        : num [1:24488104] 1 1 1 1 1 0 1 1 1 0 ...
#   .. [list output truncated]
#   ..- attr(*, ".internal.selfref")=<externalptr> 
#  $ WES_category :Classes ‘data.table’ and 'data.frame': 1357 obs. of  18352 variables:
#   ..$ model_name            : chr [1:1357] "22RV1" "22RV1" "23132-87" "253J" ...
#   ..$ model_id              : chr [1:1357] "SIDM00499" "SIDM00499" "SIDM00980" "SIDM01529" ...
#   ..$ source                : chr [1:1357] "Broad" "Sanger" "Sanger" "Broad" ...
#   ..$ symbol                : chr [1:1357] "" "" "" "" ...
#   ..$ A1BG                  : chr [1:1357] "Neutral" "Neutral" "Neutral" "Neutral" ...
#   ..$ A1CF                  : chr [1:1357] "Neutral" "Neutral" "Neutral" "Neutral" ...
#   ..$ A2M                   : chr [1:1357] "Loss" "Gain" "Neutral" "Loss" ...
#   ..$ A2ML1                 : chr [1:1357] "Neutral" "Gain" "Neutral" "Neutral" ...
#   ..$ A3GALT2               : chr [1:1357] "Neutral" "Neutral" "Neutral" "Neutral" ...
#   ..$ A4GALT                : chr [1:1357] "Neutral" "Neutral" "Neutral" "Neutral" ...
#   .. [list output truncated]
#   ..- attr(*, ".internal.selfref")=<externalptr> 
#  $ WES_total_cnv:Classes ‘data.table’ and 'data.frame': 1357 obs. of  18005 variables:
#   ..$ model_name            : chr [1:1357] "22RV1" "22RV1" "23132-87" "253J" ...
#   ..$ model_id              : chr [1:1357] "SIDM00499" "SIDM00499" "SIDM00980" "SIDM01529" ...
#   ..$ source                : chr [1:1357] "Broad" "Sanger" "Sanger" "Broad" ...
#   ..$ symbol                : chr [1:1357] "" "" "" "" ...
#   ..$ A1BG                  : chr [1:1357] "2.0" "2.0" "2.0" "3.0" ...
#   ..$ A1CF                  : chr [1:1357] "2.0" "2.0" "2.0" "3.0" ...
#   ..$ A2M                   : chr [1:1357] "0.854019261815157" "3.0" "2.0" "0.921055428175251" ...
#   ..$ A2ML1                 : chr [1:1357] "2.0" "3.0" "2.0" "2.0" ...
#   ..$ A3GALT2               : chr [1:1357] "2.0" "2.0" "2.0" "2.0" ...
#   ..$ A4GALT                : chr [1:1357] "2.0" "2.0" "2.0" "3.0" ...
#   .. [list output truncated]
#   ..- attr(*, ".internal.selfref")=<externalptr> 
#  $ WGS_genes    :Classes ‘data.table’ and 'data.frame': 3484240 obs. of  28 variables:
#   ..$ model_name                     : chr [1:3484240] "HCM-SANG-0266-C20" "HCM-SANG-0266-C20" "HCM-SANG-0266-C20" "HCM-SANG-0266-C20" ...
#   ..$ model_id                       : chr [1:3484240] "SIDM01266" "SIDM01266" "SIDM01266" "SIDM01266" ...
#   ..$ symbol                         : chr [1:3484240] "MIR1284" "MIR5094" "DDX11L1" "WASH7P" ...
#   ..$ cancer_driver                  : logi [1:3484240] FALSE FALSE FALSE FALSE FALSE FALSE ...
#   ..$ gene_id                        : chr [1:3484240] "SIDG18552" "SIDG19326" "SIDG06207" "SIDG40986" ...
#   ..$ chr_name                       : chr [1:3484240] "chr3" "chr15" "chr1" "chr1" ...
#   ..$ chr_start                      : int [1:3484240] 71541970 89850637 11869 14404 17369 29554 30366 34554 69091 187891 ...
#   ..$ chr_end                        : int [1:3484240] 71542089 89850721 14409 29570 17436 31097 30503 36081 70008 187958 ...
#   ..$ total_copy_number              : num [1:3484240] 2.98 2 2 2 2 ...
#   ..$ minor_copy_number              : num [1:3484240] 2.98 2 2 2 2 ...
#   .. [list output truncated]
#   ..- attr(*, ".internal.selfref")=<externalptr> 
#  $ WGS_category :Classes ‘data.table’ and 'data.frame': 145 obs. of  24060 variables:
#   ..$ model_name               : chr [1:145] "HCM-SANG-0265-C18" "HCM-SANG-0266-C20" "HCM-SANG-0267-D12" "HCM-SANG-0268-C18" ...
#   ..$ model_id                 : chr [1:145] "SIDM01281" "SIDM01266" "SIDM01267" "SIDM01288" ...
#   ..$ source                   : chr [1:145] "Sanger" "Sanger" "Sanger" "Sanger" ...
#   ..$ symbol                   : chr [1:145] "" "" "" "" ...
#   ..$ A1BG                     : chr [1:145] "Loss" "Neutral" "Neutral" "Neutral" ...
#   ..$ A1BG-AS1                 : chr [1:145] "Loss" "Neutral" "Neutral" "Neutral" ...
#   ..$ A1CF                     : chr [1:145] "Neutral" "Neutral" "Neutral" "Neutral" ...
#   ..$ A2M                      : chr [1:145] "Neutral" "Neutral" "Neutral" "Gain" ...
#   ..$ A2M-AS1                  : chr [1:145] "Neutral" "Neutral" "Neutral" "Gain" ...
#   ..$ A2ML1                    : chr [1:145] "Neutral" "Neutral" "Neutral" "Gain" ...
#   .. [list output truncated]
#   ..- attr(*, ".internal.selfref")=<externalptr> 
#  $ WGS_total_cnv:Classes ‘data.table’ and 'data.frame': 145 obs. of  24060 variables:
#   ..$ model_name               : chr [1:145] "HCM-SANG-0265-C18" "HCM-SANG-0266-C20" "HCM-SANG-0267-D12" "HCM-SANG-0268-C18" ...
#   ..$ model_id                 : chr [1:145] "SIDM01281" "SIDM01266" "SIDM01267" "SIDM01288" ...
#   ..$ source                   : chr [1:145] "Sanger" "Sanger" "Sanger" "Sanger" ...
#   ..$ symbol                   : chr [1:145] "" "" "" "" ...
#   ..$ A1BG                     : chr [1:145] "2.0031" "2.9518" "2.0368" "2.891" ...
#   ..$ A1BG-AS1                 : chr [1:145] "2.0031" "2.9518" "2.0368" "2.891" ...
#   ..$ A1CF                     : chr [1:145] "2.9966" "3.0134" "2.0056" "2.3861" ...
#   ..$ A2M                      : chr [1:145] "2.5265" "2.9933" "1.9935" "3.9331" ...
#   ..$ A2M-AS1                  : chr [1:145] "2.5265" "2.9933" "1.9935" "3.9331" ...
#   ..$ A2ML1                    : chr [1:145] "2.5265" "2.9933" "1.9935" "3.9331" ...
#   .. [list output truncated]
#   ..- attr(*, ".internal.selfref")=<externalptr> 

